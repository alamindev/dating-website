$(function(){var e=$("meta[name=csrf_token]").attr("content"),s=void 0,a=io(socket_url,{path:"/node/socket.io",transports:["polling","websocket"]});$(document).on("click",".conversations .message-box .delete_conversation",function(s){var t=$(s.currentTarget),n=t.attr("data-id"),i=t.attr("data-receive");confirm("Are you sure?")&&$.ajax({url:ajax_url,data:{action:"delete_conversation",id:n,_token:e},dataType:"JSON",type:"POST",success:function(e){"success"===e.status?($(".conversations .message-box").empty(),$("#conversation-"+n).remove(),a.emit("delete_conversation",{id:parseInt(n),receive_id:i})):"login"===e.status&&($(".modal").modal("hide"),$("#modalLogin").modal("show"))}})}),$(document).on("click",".conversations .message-box .write-message .send-photo",function(e){$(".conversations .message-box .write-message #imageChat").click()}),$(document).on("change",".conversations .message-box .write-message #imageChat",function(e){var s=$(e.currentTarget);if(s.get(0).files.length){var t=$(".conversations .message-box .write-message .progress");$("#uploadChat").ajaxForm({beforeSend:function(){t.css({opacity:1}),t.find(".progress-bar").css({width:0}),t.find(".progress-bar").attr("aria-valuenow",0)},uploadProgress:function(e,s,a,n){var i=n+"%";t.find(".progress-bar").css({width:i}),t.find(".progress-bar").attr("aria-valuenow",n)},complete:function(e){var n=JSON.parse(e.responseText);if("success"===n.status){var i=$("#uploadChat").attr("data-id"),o=$("#uploadChat").attr("data-receive");$("#conversation-"+i).each(function(){$(this).parent().prepend(this)}),$(".message-box .list-messages ul .mCSB_container").append(n.html),function(e){var s=document.createElement("div");s.innerHTML=e;for(var a=s.childNodes,t=a.length;t--;)if(1==a[t].nodeType)return!0;return!1}(n.message)&&(n.message='<i class="far fa-image"></i> Image'),$("#conversation-"+i).find("p").html("You: "+n.message),a.emit("send-message",{message:n.message,id:parseInt(i),receive_id:parseInt(o),message_id:parseInt(n.id),receive_html:n.receive_html,conversation_html:n.conversation_html,notice_html:n.notice_html})}s.val(""),$(".message-box .list-messages ul").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),t.find(".progress-bar").css({width:0}),t.find(".progress-bar").attr("aria-valuenow",0),t.css({opacity:0})}}),$("#uploadChat").submit()}}),$("#uploadChat").ajaxForm({beforeSend:function(){chatuploadProgress.css({opacity:1}),chatuploadProgress.find(".progress-bar").css({width:0}),chatuploadProgress.find(".progress-bar").attr("aria-valuenow",0)},uploadProgress:function(e,s,a,t){var n=t+"%";chatuploadProgress.find(".progress-bar").css({width:n}),chatuploadProgress.find(".progress-bar").attr("aria-valuenow",t)},complete:function(e){var s=JSON.parse(e.responseText);if("success"===s.status){var t=$("#uploadChat").attr("data-id"),n=$("#uploadChat").attr("data-receive");$("#conversation-"+t).each(function(){$(this).parent().prepend(this)}),$(".message-box .list-messages ul .mCSB_container").append(s.html),$("#conversation-"+t).find("p").html("You: "+s.message),a.emit("send-message",{message:s.message,id:parseInt(t),receive_id:parseInt(n),message_id:parseInt(s.id),receive_html:s.receive_html,conversation_html:s.conversation_html,notice_html:s.notice_html})}el.val(""),$(".message-box .list-messages ul").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),chatuploadProgress.find(".progress-bar").css({width:0}),chatuploadProgress.find(".progress-bar").attr("aria-valuenow",0),chatuploadProgress.css({opacity:0})}}),$(document).on("keyup",".conversations .message-box input.message-input",function(t){t.preventDefault();var n=$(t.currentTarget),i=t.keyCode?t.keyCode:t.which,o=n.attr("data-id"),r=n.attr("data-receive"),c=n.attr("data-sendername");if(13===i){clearTimeout(s),function(e,s){!1,a.emit("stop-typing",{id:parseInt(e),receive_id:parseInt(s)})}(o,r);var d=n.val();$.ajax({url:ajax_url,data:{action:"send_message",id:o,text:d,_token:e},dataType:"JSON",type:"POST",success:function(e){n.val(""),"success"===e.status?($("#conversation-"+o).each(function(){$(this).parent().prepend(this)}),$(".message-box .list-messages ul .mCSB_container").append(e.html),$("#conversation-"+o).find("p").html("You: "+d),$(".message-box .list-messages ul").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),a.emit("send-message",{message:d,id:parseInt(o),receive_id:parseInt(r),message_id:parseInt(e.id),receive_html:e.receive_html,conversation_html:e.conversation_html,notice_html:e.notice_html})):"login"===e.status?($(".modal").modal("hide"),$("#modalLogin").modal("show")):"wait"===e.status&&$(".message-box .write-message").addClass("waiting")}})}else a.emit("typing-message",{id:parseInt(o),receive_id:parseInt(r),sender_name:c}),clearTimeout(s),s=setTimeout(function(){!1,a.emit("stop-typing",{id:parseInt(o),receive_id:parseInt(r)})},3e3)}),$(document).on("click",".conversations .list-conversations .conversation-item",function(s){var t=$(s.currentTarget),n=t.attr("data-id");$.ajax({url:ajax_url,data:{action:"load_conversation",id:n,_token:e},dataType:"JSON",type:"POST",success:function(e){"success"===e.status&&($(".conversations .list-conversations .conversation-item").removeClass("active"),t.addClass("active"),$(".conversations .message-box").empty(),$(".conversations .message-box").append(e.html),0===e.unread?$("#message-sidebar .badge").empty():$("#message-sidebar .badge").text(e.unread),window.history.pushState({},null,e.url),$(".conversations .message-box .list-messages ul").mCustomScrollbar().mCustomScrollbar("scrollTo","bottom",{scrollInertia:0}),a.emit("seen-all-message",n))}})}),a.on("seen-all-message",function(e){var s=$("#message-box-"+e);s.length&&s.find(".message.self .message-detail span").text("Seen")}),a.on("seen-message",function(e){var s=$("#message-box-"+e.id),a=$("#message-"+e.message_id);s.length&&a.length&&a.find(".message-detail span").text("Seen")}),a.on("delete_conversation",function(e){var s=$("#conversation-"+e.id),a=$("#message-box-"+e.id);s.length&&s.remove(),a.length&&$(".conversations .message-box").empty()}),a.on("receive-message",function(s){if(s.receive_id===logged_id){var t=$("#conversation-"+s.id),n=$("#message-box-"+s.id);if($(".conversations").length){if(t.length?(t.each(function(){$(this).parent().prepend(this)}),t.find("p").html(s.message)):$(".list-conversations ul").prepend(s.conversation_html),n.length)$.ajax({url:ajax_url,data:{id:s.message_id,action:"seen",_token:e},dataType:"JSON",type:"POST",success:function(e){}}),$("#message-box-"+s.id+" .list-messages ul .mCSB_container").append(s.receive_html),a.emit("seen-message",{id:s.id,message_id:s.message_id}),$("#message-box-"+s.id+" .list-messages ul").mCustomScrollbar("scrollTo","bottom",{scrollInertia:0});else i=""===(i=$("#message-sidebar .badge").text())?0:parseInt(i),$("#message-sidebar .badge").text(i+1)}else{var i,o=$(s.notice_html);3===$(".notifications .notification").length&&$(".notifications .notification:last-child").remove(),o.prependTo(".notifications").delay(6e4).queue(function(){$(this).remove()}),i=""===(i=$("#message-sidebar .badge").text())?0:parseInt(i),$("#message-sidebar .badge").text(i+1)}document.getElementById("message_audio").play()}}),a.on("receive-typing-message",function(e){var s=$("#message-box-"+e.id);e.receive_id===logged_id&&s.length&&(s.find(".write-message .typing").html(e.sender_name+' is typing <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>'),s.find(".write-message .typing").show())}),a.on("receive-stop-typing",function(e){var s=$("#message-box-"+e.id);e.receive_id===logged_id&&s.length&&s.find(".write-message .typing").hide()}),a.on("call-incoming",function(e){if(e.receive_id===logged_id){var s='<div class="incoming__notifacition_main">        <div class="call__notification">            <h2 class="incoming__call_name">Incoming call from '+e.name+'</h2>            <div class="call-animation incoming__call_image">                <img class="rounded-circle" src="'+e.avatar+'" alt="" width="135"/>            </div>            <div class="incoming__call_btn">                <a href="'+e.url+'" class="incoming__accept_btn">Accept</a>                <button type="button" class="incoming__reject_btn border-0" data-sender_id="'+e.sender_id+'" data-receive_id="'+e.receive_id+'">Reject</button>            </div>        </div>    </div>';$(".notifications").prepend(s);var a=$("#audio_source").val(),t=document.createElement("audio");t.id="audio-player",t.class="d-none",t.src=a,t.type="audio/mpeg",t.autoplay=!0,$(".notifications").appendChild(t),audiojs.events.ready(function(){audiojs.createAll()})}}),a.on("cancel-call",function(e){e.receive_id===logged_id&&($(".notifications").empty(),document.getElementById("calling_audio").pause())}),a.on("notifications",function(e){console.log(e)}),$(document).on("click",".incoming__reject_btn",function(e){var s=$(this).data("sender_id"),t=$(this).data("receive_id");a.emit("reject-call",{sender_id:s,receive_id:t}),$(".notifications").empty(),document.getElementById("calling_audio").pause()})});
