$(function(){$("meta[name=csrf_token]").attr("content");var e=$("#video-element").data("video"),i=$("#video-element").data("url"),o=$("#video-element").data("avater"),a=$("#video-element").data("name"),n=$("#video-element").data("receiver-url"),d=$("#video-element").data("sender-url"),t=$("#video-element").data("main-url"),r=$("#video-element").data("caller-url"),c=$("#video-element").data("username"),l=io(socket_url,{path:"/node/socket.io",transports:["polling","websocket"]});function s(c){setTimeout(function(){function c(e){const i=document.createElement("div");i.id=e.sid,e.on("trackAdded",e=>m(i,e)),e.tracks.forEach(e=>m(i,e)),e.on("trackRemoved",g),$("#remote-media").html(i),$(".end_vdo_call").removeClass("d-none"),$(".end_vdo_call_before").addClass("d-none"),$(".audiojs").empty()}function s(e){e.tracks.forEach(g),document.getElementById(e.sid).remove(),window.location.href=t,$(".audiojs").empty()}function m(e,i){e.appendChild(i.attach())}function g(e){e.detach().forEach(e=>e.remove())}$("#audioFrenata").on("ended",function(){manageImageObjectsLevel()}).get(0).play(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia||$("#remote-media h3").text("Sorry, WebRTC is not available in your browser."),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){document.getElementById("basic-stream").srcObject=e}),Twilio.Video.connect(logged_id===e.sender_id?e.access_token:e.access_token_2,{name:e.room_name,audio:!0,video:{height:720,frameRate:24,width:1280},bandwidthProfile:{video:{mode:"grid",maxTracks:10,renderDimensions:{high:{height:1080,width:1980},standard:{height:720,width:1280},low:{height:176,width:144}}}},maxAudioBitrate:16e3,networkQuality:{local:1,remote:1}}).then(t=>{t.participants.forEach(c),t.on("participantConnected",c),logged_id==e.sender_id&&l.emit("call-incoming",{sender_id:e.sender_id,url:i,avatar:o,receive_id:e.receive_id,name:a}),t.on("participantDisconnected",s),t.once("disconnected",e=>t.participants.forEach(s)),$(document).on("click","a[data-ajax]",function(e){t.disconnect()}),$(document).on("click",".end_vdo_call",function(i){confirm("You are on call. Are you sure to exit?")&&(logged_id==e.sender_id&&l.emit("cancel-call",{receive_id:e.receive_id}),t.disconnect(),logged_id==e.sender_id&&(window.location.href=n),logged_id==e.receive_id&&(window.location.href=d))})}),l.on("reject-call",function(e){var i=logged_id;e.sender_id==i&&(window.location.href=r+e.receive_id)})},1e3)}function m(){confirm("Camera not found! Please go back.")&&(l.emit("camera-not-found",{sender_id:e.sender_id,username:c}),setTimeout(()=>{logged_id==e.sender_id&&(window.location.href=n),logged_id==e.receive_id&&(window.location.href=d)},500))}audiojs.events.ready(function(){audiojs.createAll()}),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,void 0===navigator.mediaDevices.getUserMedia?navigator.getUserMedia({audio:!0,video:!0},s,m):navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(s).catch(m),$(document).on("click",".end_vdo_call_before",function(i){confirm("You are on call. Are you sure to exit?")&&(logged_id==e.sender_id&&l.emit("cancel-call",{receive_id:e.receive_id}),logged_id==e.sender_id&&(window.location.href=n),logged_id==e.receive_id&&(window.location.href=d))}),l.on("camera-not-found",function(i){confirm(i.username+" camera is not found! Please go back.")&&logged_id==e.sender_id&&(window.location.href=n)})});
